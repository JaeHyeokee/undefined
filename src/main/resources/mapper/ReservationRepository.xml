<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lec.spring.repository.ReservationRepository">
    <resultMap id="ReservationResultMap" type="com.lec.spring.domain.Reservation">
        <id property="reservationId" column="reservation_id" />
        <result property="reservationTime" column="reservation_time" />
        <result property="reservationAdult" column="reservation_adult" />
        <result property="reservationChild" column="reservation_child" />
        <result property="visitorName" column="visitor_name" />
        <result property="visitorPhoneNum" column="visitor_phonenum" />
        <result property="reservationPayType" column="reservation_paytype" />
        <result property="reservationFinalPay" column="reservation_finalpay" />
        <result property="reservationStartDate" column="reservation_startdate" />
        <result property="reservationEndDate" column="reservation_enddate" />
        <result property="roomId" column="room_id" />
        <result property="userId" column="user_id" />
    </resultMap>

    <resultMap id="UserResultMap" type="com.lec.spring.domain.User">
        <id property="userid" column="user_id" />
        <result property="nickname" column="user_nickname" />
        <result property="username" column="user_name" />
        <result property="email" column="user_email" />
        <result property="phonenum" column="user_phonenum" />
    </resultMap>

    <resultMap id="LodgingResultMap" type="com.lec.spring.domain.Lodging">
        <id property="lodgingId" column="lodging_id" />
        <result property="lodgingName" column="lodging_name" />
        <result property="lodgingType" column="lodging_type" />
        <result property="lodgingOpen" column="lodging_open" />
        <result property="lodgingClose" column="lodging_close" />
        <result property="uerId" column="user_id"/>
    </resultMap>

    <resultMap id="RoomResultMap" type="com.lec.spring.domain.Room">
        <id property="roomId" column="room_id" />
        <result property="roomName" column="room_name" />
        <result property="roomPrice" column="room_price" />
        <result property="lodgingId" column="lodging_id" />
    </resultMap>

    <!-- 예약 삽입 -->
    <insert id="insertReservation" useGeneratedKeys="true" keyProperty="reservationId">
        INSERT INTO reservation (
            reservation_time,
            reservation_adult,
            reservation_child,
            visitor_name,
            visitor_phonenum,
            reservation_paytype,
            reservation_finalpay,
            reservation_startdate,
            reservation_enddate,
            room_id,
            user_id
        )
        VALUES (
                   NOW(),
                   #{reservationAdult},
                   #{reservationChild},
                   #{visitorName},
                   #{visitorPhoneNum},
                   #{reservationPayType},
                   #{reservationFinalPay},
                   #{reservationStartDate},
                   #{reservationEndDate},
                   #{roomId},
                   #{userid}
               )
    </insert>

    <!-- 필요한 정보 JOIN하여 가져오기 -->
    <select id="getReservationDetails" resultType="map">
        SELECT
            u.user_name ,
            u.user_phonenum ,
            l.lodging_name,
            r.room_name,
            r.room_price,
            r.room_id,
            u.user_id
        FROM user u
                 JOIN reservation res ON u.user_id = res.user_id
                 JOIN room r ON res.room_id = r.room_id
                 JOIN lodging l ON r.lodging_id = l.lodging_id
        WHERE res.reservation_id = #{reservationId}
    </select>


    <insert id="save" parameterType="com.lec.spring.domain.Reservation" useGeneratedKeys="true" keyProperty="reservationId">
        INSERT INTO reservation (
            reservation_time,
            reservation_adult,
            reservation_child,
            visitor_name,
            visitor_phonenum,
            reservation_paytype,
            reservation_pay,
            reservation_finalpay,
            reservation_startdate,
            reservation_enddate,
            room_id,
            user_id
        ) VALUES (
                     NOW(),
                     #{reservationAdult},
                     #{reservationChild},
                     #{visitorName},
                     #{visitorPhoneNum},
                     #{reservationPayType},
                     #{reservationPay},
                     #{reservationFinalPay},
                     #{reservationStartDate},
                     #{reservationEndDate},
                     #{room.roomId},
                     #{user.userId}
                 )
    </insert>
</mapper>